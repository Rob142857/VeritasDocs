# Veritas Documents

A secure NFT-based legal document storage system built on Cloudflare Workers with post-quantum cryptography.

## Features

- **Post-Quantum Security**: Uses Maatara protocol for Kyber encryption and Dilithium signatures
- **NFT-Based Storage**: Each document is stored as a unique, immutable NFT
- **Stripe Integration**: $25 fee for account creation and asset minting
- **IPFS Storage**: Encrypted documents stored on IPFS for decentralized access
- **Admin-Controlled Onboarding**: One-time activation links generated by administrators
- **Search & Provenance**: Public search functionality with ownership history
- **Clean UI**: Minimalist, professional interface focused on functionality

## Architecture

- **Frontend**: Vanilla JavaScript SPA with clean, responsive design
- **Backend**: Cloudflare Workers with Hono framework
- **Database**: Cloudflare KV for user data and asset metadata
- **Payments**: Stripe for secure payment processing
- **Storage**: IPFS for encrypted document storage
- **Crypto**: Maatara protocol for post-quantum cryptography
- **Blockchain**: Custom Veritas chain for immutable transaction records

## Project Structure

```
veritas-documents/
├── src/
│   ├── index.ts              # Main worker entry point
│   ├── types/
│   │   └── index.ts          # TypeScript type definitions
│   ├── utils/
│   │   └── crypto.ts         # Maatara crypto utilities
│   └── handlers/
│       ├── auth.ts           # Authentication & account creation
│       ├── users.ts          # User management
│       ├── assets.ts         # Asset/NFT operations
│       ├── stripe.ts         # Payment processing
│       └── search.ts         # Asset search & provenance
├── public/
│   ├── styles.css            # Clean, minimalist styles
│   └── app.js                # Frontend JavaScript app
├── package.json
├── tsconfig.json
├── wrangler.toml             # Cloudflare Workers configuration
└── README.md
```

## Setup Instructions

### 1. Install Dependencies

```bash
npm install
```

### 2. Configure Secrets

Use Wrangler to set up your environment secrets:

```bash
# Stripe configuration
wrangler secret put STRIPE_SECRET_KEY
wrangler secret put STRIPE_WEBHOOK_SECRET

# Maatara protocol
wrangler secret put MAATARA_CHAIN_PRIVATE_KEY

# IPFS storage
wrangler secret put IPFS_API_KEY

# Admin access
wrangler secret put ADMIN_SECRET_KEY
```

### 3. Set up KV Namespace

```bash
# Create KV namespace
wrangler kv:namespace create "VERITAS_KV"

# Update wrangler.toml with the returned namespace ID
```

### 4. Configure Stripe Webhooks

1. Set up a webhook endpoint in your Stripe dashboard
2. Point it to: `https://your-worker-domain.workers.dev/api/stripe/webhook`
3. Enable these events:
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`

### 5. Deploy

```bash
# Deploy to Cloudflare Workers
npm run deploy
```

## User Flow

### 1. Admin Creates Invitation
- Admin uses the `/api/auth/create-link` endpoint with admin secret
- One-time activation link is generated and expires in 7 days

### 2. User Account Activation
- User clicks activation link and provides personal details
- System generates Kyber keypair and 12-word recovery phrase
- User data encrypted with app's public key for admin access
- Account creation recorded on Veritas blockchain

### 3. Asset Creation
- User pays $25 via Stripe integration
- Document encrypted with user's public key
- Encrypted document uploaded to IPFS
- Asset metadata signed with user's Dilithium key
- NFT created and recorded on blockchain

### 4. Asset Management
- Users can view owned and created assets
- Transfer ownership (requires $25 fee for new recipients)
- Set public searchability preferences
- Search public assets and view provenance

## API Endpoints

### Authentication
- `POST /api/auth/create-link` - Generate one-time activation link (admin only)
- `POST /api/auth/activate` - Activate account with personal details
- `POST /api/auth/login` - User login with email and private key

### Assets
- `POST /api/assets/create` - Create new asset/NFT
- `GET /api/assets/:id` - Get asset details
- `GET /api/assets/user/:userId` - Get user's assets
- `POST /api/assets/transfer` - Transfer asset ownership

### Users
- `GET /api/users/profile/:userId` - Get user profile
- `POST /api/users/invite` - Create invitation link (paid users only)

### Payments
- `POST /api/stripe/create-payment-intent` - Create payment for fees
- `POST /api/stripe/webhook` - Handle Stripe webhooks
- `GET /api/stripe/transaction/:id` - Get transaction status

### Search
- `GET /api/search` - Search public assets
- `GET /api/search/provenance/:assetId` - Get asset ownership history
- `GET /api/search/document-types` - Get available document types

## Environment Variables

Required environment variables in `wrangler.toml`:

```toml
[vars]
ENVIRONMENT = "development"
MAATARA_API_BASE = "https://maatara-core-worker.rme-6e5.workers.dev"
```

## Security Features

- **Post-Quantum Cryptography**: Resistant to quantum computer attacks
- **End-to-End Encryption**: Documents encrypted before IPFS storage
- **Digital Signatures**: All transactions signed with Dilithium signatures
- **Admin-Controlled Access**: Account creation requires administrator approval
- **Immutable Records**: All transactions recorded on blockchain
- **Secure Key Management**: User keys generated using proven protocols

## Development

```bash
# Start development server
npm run dev

# Build TypeScript
npm run build

# Run linting
npm run lint

# Format code
npm run format
```

## Production Considerations

1. **Key Security**: Implement secure key backup and recovery mechanisms
2. **Scalability**: Consider indexing solutions for large-scale asset search
3. **Monitoring**: Set up error tracking and performance monitoring
4. **Compliance**: Ensure compliance with relevant legal document storage regulations
5. **Backup**: Implement redundant storage for critical data

## License

MIT License - see LICENSE file for details.

## Support

For technical support or questions, please contact the development team.